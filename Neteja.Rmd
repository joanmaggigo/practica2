---
title: 'PRACTICA 2: LIMPIEZA Y VALIDACIÓN DE LOS DATOS'
author: "Carles Maggi Gómez"
tuthor: "Joan A. Maggi Gómez"
date: '`r format(Sys.Date(),"%e de %B %Y")`'
output:
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
if (!require("knitr")){
  install.packages("knitr")
}
knitr::opts_chunk$set(echo = TRUE)
Encoding = "UTF-8"
```

```{r  Carregem les llibreries si ens calen, include=FALSE}
if (!require("rmarkdown")){
  install.packages("rmarkdown")
}

if (!require("lubridate")){
  install.packages("lubridate")
}

if (!require("dplyr")){
  install.packages("dplyr")
}
library(rmarkdown)
library(lubridate)
library(dplyr)

```
Partim de tres fitxers que cal unificar en un sol per poder ser tratat

```{r, Carrega Dades ,echo=TRUE}

# Lectura del fitxer - read.csv() 

categories <-read.csv("https://raw.githubusercontent.com/joanmaggigo/practica2/master/CSV/CategoriesXComentariBooking.csv",header=F,sep=",",encoding = "UTF-8" ,stringsAsFactors = FALSE)
comentaris <-read.csv("https://raw.githubusercontent.com/joanmaggigo/practica2/master/CSV/ComentarisXHotelsBarcelonaBooking.csv",header=F,sep=",",encoding = "UTF-8" ,stringsAsFactors = FALSE)
estancies<-read.csv("https://raw.githubusercontent.com/joanmaggigo/practica2/master/CSV/HotelsBarcelonaBooking.csv",header=F,sep=",",encoding = "UTF-8" ,stringsAsFactors = FALSE)


colnames(estancies)<-c("idHotel","estrelles","nota","nom","link")
colnames(comentaris)<-c("idHotel","idIteracio","index","nomHotel","nota","comPositiu","comNegatiu","data")
colnames(categories)<-c("idHotel","idIteracio","index","Categoria")

```

****
# Descripcó dels dataset.
****
Podem trobar el dataset e el següent repositori :

https://github.com/joanmaggigo/practica2/CSV


El dataset d'hotels  conté `r nrow(estancies)` registres i  `r ncol(estancies)` variables. 
El dataset de comentaris conte `r nrow(comentaris)` registres i  `r ncol(comentaris)` variables. 
El dataset de categories per comentaries conte `r nrow(categories)` registres i  `r ncol(categories)` variables. 

El que pretenem fer es estudiar les relacions entre les categories i la nota de l'hotel. Fem una primera inspecció visual ens adonem que el que està catalogat com categoria no son les categories sinó els valors que poden pendre les categories.

A tall d'exemple, veiem que el fitxer de categories té valors com ara Pareja o Grupo que entenem que són valors possibles dins la categoria d'acompanyament (o tipus d'acompanyament)

`r head(categories)`

D'altra banda, quan mirem el fitxer d'hotels, veiem que existeixen valors d'estrelles = 0 que mirant el nom de l'hotel veiem que no són hotels
`r kable(head(estancies[estancies$estreles==0,"nomHotel"]))`

Començarem a abordar el problema, fent el merge dels datasets, i analitzant el tema de les categories nomesamb els hotels, no tenint en compte els apartaments ( Estrelles = 0)

```{r, echo=TRUE}
# Creem un única dataset que fusiona tots els comentaries i categories
comentaris.cat<-merge(comentaris,categories,by.x=c("idHotel","idIteracio","index"),by.y=c("idHotel","idIteracio","index"))
# Fem el merge amb hotels
hotels.comentaris.cat<-merge(comentaris.cat,estancies, by.x="idHotel", by.y="idHotel")
hotels<-hotels.comentaris.cat[which(hotels.comentaris.cat$estrelles!=0),]

#Veiem, per descrició de dataset que el identificador de la persona/comentari es la concateniació del idhotel, ititeració i index.
hotels$idPersona <- paste(as.character(hotels$idHotel), as.character(hotels$idIteracio), as.character(hotels$index),sep="_")

#Anem a valorar quantes categories hi ha per comentaris, per veure si podem convertir en n variables descrivint un aspecte de l'hotel, com ara numero de nits, tipus d'estancia, etc.. primer mirem com es distribueixen per numero de categories
categoria_per_comentari <- hotels %>% group_by(idPersona) %>% summarize(total_cat=n())
comentaris_per_num_categories<-categoria_per_comentari %>% group_by(total_cat) %>% summarize(total_comentaris=n())
kable(comentaris_per_num_categories, caption="Total Valors categories per comentaris")
```



****
# Limpieza de datos
****

En primer lloc vam pensar en agrupar només en 5 categories, tenint en compte que el comentaris que en tenen 6 eren pocs i ens semblaven irrellevants.Finalment, ens hem adonat que això tenia efectes sobre altres comentaris perquè ens hem trobat que per un mateixa categoria en un comentari hi havia dos valors possibles, pel que el primer procés d'agrupació ha sigut erroni i hem detectat on teniem l'error. L'error  era sobre el valor "AmbMascota" que l'haviem considerat inicialment com tipus de companyia pero era un element diferenciat. 

```{r, echo=TRUE}
idpersona_6categories<-unique(categoria_per_comentari[categoria_per_comentari$total_cat==6,"idPersona"])

kable(head(hotels[(hotels$idPersona %in% idpersona_6categories$idPersona ),][c("idPersona","Categoria")],20))


```

Estudiant visualment les categories pensem que podem agrupar en 6 grups. veiem valors que podrien respondre a les categories: Nits,ProcedenciaComentaria,Habitació,TipusdeViatge,Acompanyament,ViatjeAmbMascota


```{r, echo=TRUE}
#Estudiem el nombre de comentaris agrupats per categoria per començar a definir els tipus de categoria.

kable(head(hotels %>% group_by(Categoria) %>% summarize(total_cat=n()) %>% arrange(desc(total_cat)),20))
```

En funció de volum comencem a veure patrons per tal de poder crear l'agrupació de la categoria

```{r, echo=TRUE}
#La agrupació de categoria la inicialitzo amb la agrupació alltres/darrer
hotels$agrupacio_categoria<-"Acompanyament"
hotels[grep("stancia",hotels$Categoria),"agrupacio_categoria"]<-"Nits"
hotels[grep("Enviadopormóvil",hotels$Categoria),"agrupacio_categoria"]<-"ProcedenciaComentari"
hotels[grep("abitaci",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("uite",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("DobleEstándar",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("Apartamento",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("Viaje",hotels$Categoria),"agrupacio_categoria"]<-"TipusViatge"
hotels[grep("Viaje",hotels$Categoria),"agrupacio_categoria"]<-"TipusViatge"
hotels[grep("mascota",hotels$Categoria),"agrupacio_categoria"]<-"ViajaConMascota"


agrupacio_categoria<-unique(hotels$agrupacio_categoria)
for (cols in agrupacio_categoria) 
{
  aux<-hotels[which(hotels$agrupacio_categoria==cols),]
  aux2<-aux %>% group_by(Categoria) %>% summarize(total_cat=n())
  print(head(aux2,20), caption=as.character(cols))
}

```

Veiem que en el cas de l'agrupació que ens explica el tipus d'habitació i el nombre de nits és interesant recategoritzar la variable, per què hi ha mases valors possibles i alguns amb pocs representats, pel que guanya força sentit.

```{r, echo=TRUE}
#Recategoritzem dues agrupacions de categories, en funció dels valors observats. Seran l'agrupació Habitació, y la agrupació Nits

hotels$ReCategoria<-hotels$Categoria
#A les estancies de mes de 7 dies diem que la nova categoria es mésde7dies
hotels[which(hotels$agrupacio_categoria=="Nits" & as.numeric(gsub("\\D", "",hotels$Categoria))>7) ,"ReCategoria"]<-"Mesde7"

#A les habitacions les recategoritzem en funció de la descripció i del que sembla raonable per volums.
hotels[which(hotels$agrupacio_categoria=="Habitacio"),"ReCategoria"]<-"Altres"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("oble",hotels$Categoria),"ReCategoria"]<-"Habitacio Doble"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("ndividual",hotels$Categoria),"ReCategoria"]<-"Habitacio Individual"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("uite",hotels$Categoria),"ReCategoria"]<-"Suite"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("riple",hotels$Categoria),"ReCategoria"]<-"Habitacio Triple"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("druple",hotels$Categoria),"ReCategoria"]<-"Habitacio quadruple"
hotels.Habitacio$ReCategoria<-as.factor(hotels.Habitacio$ReCategoria)

agrupacio_categoria_habitacion<-unique(hotels.Habitacio$ReCategoria)
for (cols in agrupacio_categoria_habitacion) 
{
print(head(hotels.Habitacio[which(hotels.Habitacio$ReCategoria==cols),] %>% group_by(Categoria) %>% summarize(total_cat=n()),10))
}
```

La recategorització sembla raonable respecte els valors observats, per tant ja podem procedir a contruir el dataset de partida per evaluar els objectius descrits

```{r, echo=TRUE}


#Anem a crear el Dataset de treball

#Creem un identificador de persona
categories_per_persona<-hotels %>% group_by(idPersona) %>% summarize(total_cat=n())

#Creem el dataset de treball
data<-unique(hotels[c("nomHotel","nota.x","data","estrelles","idPersona","nota.y")])
data<-merge(data,categories_per_persona,by.x="idPersona",by.y="idPersona")


#Creem un dataset que ajunti el idcomentari amb l'agrupació de categoria
data.Habitacio<-hotels[hotels$agrupacio_categoria=="Habitacio",]
data.Habitacio<-data.Habitacio[c("idPersona","ReCategoria")]
data.Nits<-hotels[hotels$agrupacio_categoria=="Nits",]
data.Nits<-data.Nits[c("idPersona","ReCategoria")]
data.ProcedenciaComentari<-hotels[hotels$agrupacio_categoria=="ProcedenciaComentari",]
data.ProcedenciaComentari<-data.ProcedenciaComentari[c("idPersona","ReCategoria")]
data.TipusViatge<-hotels[hotels$agrupacio_categoria=="TipusViatge",]
data.TipusViatge<-data.TipusViatge[c("idPersona","ReCategoria")]
data.Acompanyament<-hotels[hotels$agrupacio_categoria=="Acompanyament",]
data.Acompanyament<-data.Acompanyament[c("idPersona","ReCategoria")]
data.ViajaConMascota<-hotels[hotels$agrupacio_categoria=="ViajaConMascota",]
data.ViajaConMascota<-data.ViajaConMascota[c("idPersona","ReCategoria")]

#fem els merges per crear el ddataset de treball
data<-merge(data,data.Habitacio,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.Nits,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.ProcedenciaComentari,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.TipusViatge,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.Acompanyament,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.ViajaConMascota,by.x="idPersona",by.y="idPersona",all.x = T)


colnames(data)<-c("idPersona","nomHotel","notaHotel","data","estrelles","notaPersona","num_cat","TipusHabitacio","Nits","ProcedenciaComentari","TipusViatge","Acompanyament","ViajaConMascota")

idPersona.r<-data %>% group_by(idPersona) %>% summarise(total=n()) %>% filter(total>1)
data[(data$idPerson %in% idPersona.r$idPersona),]
```


