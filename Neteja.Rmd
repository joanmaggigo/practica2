---
title: 'PRACTICA 2: LIMPIEZA Y VALIDACIÓN DE LOS DATOS'
author: "Carles Maggi Gómez"
tuthor: "Joan A. Maggi Gómez"
date: '`r format(Sys.Date(),"%e de %B %Y")`'
output:
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
if (!require("knitr")){
  install.packages("knitr")
}
knitr::opts_chunk$set(echo = TRUE)
Encoding = "UTF-8"
```

```{r  Carregem les llibreries si ens calen, include=FALSE}
if (!require("rmarkdown")){
  install.packages("rmarkdown")
}

if (!require("lubridate")){
  install.packages("lubridate")
}

if (!require("dplyr")){
  install.packages("dplyr")
}
library(rmarkdown)
library(lubridate)
library(dplyr)

```
Partim de tres fitxers que cal unificar en un sol per poder ser tratat

```{r, Carrega Dades ,echo=TRUE}

# Lectura del fitxer - read.csv() 

categories <-read.csv("https://raw.githubusercontent.com/joanmaggigo/practica2/master/CSV/CategoriesXComentariBooking.csv",header=F,sep=",",encoding = "UTF-8" ,stringsAsFactors = FALSE)
comentaris <-read.csv("https://raw.githubusercontent.com/joanmaggigo/practica2/master/CSV/ComentarisXHotelsBarcelonaBooking.csv",header=F,sep=",",encoding = "UTF-8" ,stringsAsFactors = FALSE)
estancies<-read.csv("https://raw.githubusercontent.com/joanmaggigo/practica2/master/CSV/HotelsBarcelonaBooking.csv",header=F,sep=",",encoding = "UTF-8" ,stringsAsFactors = FALSE)


colnames(estancies)<-c("idHotel","estrelles","nota","nom","link")
colnames(comentaris)<-c("idHotel","idIteracio","index","nomHotel","nota","comPositiu","comNegatiu","data")
colnames(categories)<-c("idHotel","idIteracio","index","Categoria")

```

***
# Descripcó dels dataset.
***
Podem trobar el dataset e el següent repositori :

https://github.com/joanmaggigo/practica2/CSV


El dataset d'hotels  conté `r nrow(estancies)` registres i  `r ncol(estancies)` variables. 
El dataset de comentaris conte `r nrow(comentaris)` registres i  `r ncol(comentaris)` variables. 
El dataset de categories per comentaries conte `r nrow(categories)` registres i  `r ncol(categories)` variables. 

El que pretenem fer es estudiar les relacions entre les categories i la nota de l'hotel. Fem una primera inspecció visual ens adonem que el que està catalogat com categoria no son les categories sinó els valors que poden pendre les categories.

A tall d'exemple, veiem que el fitxer de categories té valors com ara Pareja o Grupo que entenem que són valors possibles dins la categoria d'acompanyament (o tipus d'acompanyament)

```{r, echo=TRUE}
head(categories)
```

D'altra banda, quan mirem el fitxer d'hotels, veiem que existeixen valors d'estrelles = 0 que mirant el nom de l'hotel veiem que no són hotels

```{r, echo=TRUE}
head(estancies[(estancies$estrelles==0),"nom"])

```

Començarem a abordar el problema, fent el merge dels datasets, i analitzant el tema de les categories nomesamb els hotels, no tenint en compte els apartaments ( Estrelles = 0)

```{r, echo=TRUE}
# Creem un única dataset que fusiona tots els comentaries i categories
comentaris.cat<-merge(comentaris,categories,by.x=c("idHotel","idIteracio","index"),by.y=c("idHotel","idIteracio","index"))
# Fem el merge amb hotels
hotels.comentaris.cat<-merge(comentaris.cat,estancies, by.x="idHotel", by.y="idHotel")
hotels<-hotels.comentaris.cat[which(hotels.comentaris.cat$estrelles!=0),]

#Veiem, per descrició de dataset que el identificador de la persona/comentari es la concateniació del idhotel, ititeració i index.
hotels$idPersona <- paste(as.character(hotels$idHotel), as.character(hotels$idIteracio), as.character(hotels$index),sep="_")

#Anem a valorar quantes categories hi ha per comentaris, per veure si podem convertir en n variables descrivint un aspecte de l'hotel, com ara numero de nits, tipus d'estancia, etc.. primer mirem com es distribueixen per numero de categories
categoria_per_comentari <- hotels %>% group_by(idPersona) %>% summarize(total_cat=n())
comentaris_per_num_categories<-categoria_per_comentari %>% group_by(total_cat) %>% summarize(total_comentaris=n())
kable(comentaris_per_num_categories, caption="Total Valors categories per comentaris")
```



****
# Limpieza de datos
****

En primer lloc vam pensar en agrupar només en 5 categories, tenint en compte que el comentaris que en tenen 6 eren pocs i ens semblaven irrellevants.Finalment, ens hem adonat que això tenia efectes sobre altres comentaris perquè ens hem trobat que per un mateixa categoria en un comentari hi havia dos valors possibles, pel que el primer procés d'agrupació ha sigut erroni i hem detectat on teniem l'error. L'error  era sobre el valor "AmbMascota" que l'haviem considerat inicialment com tipus de companyia pero era un element diferenciat. 

```{r, echo=TRUE}
idpersona_6categories<-unique(categoria_per_comentari[categoria_per_comentari$total_cat==6,"idPersona"])

kable(head(hotels[(hotels$idPersona %in% idpersona_6categories$idPersona ),][c("idPersona","Categoria")],20))


```

Estudiant visualment les categories pensem que podem agrupar en 6 grups. veiem valors que podrien respondre a les categories: Nits,ProcedenciaComentaria,Habitació,TipusdeViatge,Acompanyament,ViatjeAmbMascota


```{r, echo=TRUE}
#Estudiem el nombre de comentaris agrupats per categoria per començar a definir els tipus de categoria.

kable(head(hotels %>% group_by(Categoria) %>% summarize(total_cat=n()) %>% arrange(desc(total_cat)),20))
```

En funció de volum comencem a veure patrons per tal de poder crear l'agrupació de la categoria

```{r, echo=TRUE}
#La agrupació de categoria la inicialitzo amb la agrupació alltres/darrer
hotels$agrupacio_categoria<-"Acompanyament"
hotels[grep("stancia",hotels$Categoria),"agrupacio_categoria"]<-"Nits"
hotels[grep("Enviadopormóvil",hotels$Categoria),"agrupacio_categoria"]<-"ProcedenciaComentari"
hotels[grep("abitaci",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("uite",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("DobleEstándar",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("Apartamento",hotels$Categoria),"agrupacio_categoria"]<-"Habitacio"
hotels[grep("Viaje",hotels$Categoria),"agrupacio_categoria"]<-"TipusViatge"
hotels[grep("Viaje",hotels$Categoria),"agrupacio_categoria"]<-"TipusViatge"
hotels[grep("mascota",hotels$Categoria),"agrupacio_categoria"]<-"ViajaConMascota"


agrupacio_categoria<-unique(hotels$agrupacio_categoria)
for (cols in agrupacio_categoria) 
{
  aux<-hotels[which(hotels$agrupacio_categoria==cols),]
  aux2<-aux %>% group_by(Categoria) %>% summarize(total_cat=n())
  print(head(aux2,20), caption=as.character(cols))
}

```

Veiem que en el cas de l'agrupació que ens explica el tipus d'habitació i el nombre de nits és interesant recategoritzar la variable, per què hi ha mases valors possibles i alguns amb pocs representats, pel que guanya força sentit.

```{r, echo=TRUE}
#Recategoritzem dues agrupacions de categories, en funció dels valors observats. Seran l'agrupació Habitació, y la agrupació Nits

hotels$ReCategoria<-hotels$Categoria
#A les estancies de mes de 7 dies diem que la nova categoria es mésde7dies
hotels[which(hotels$agrupacio_categoria=="Nits" & as.numeric(gsub("\\D", "",hotels$Categoria))>7) ,"ReCategoria"]<-"Mesde7"

#A les habitacions les recategoritzem en funció de la descripció i del que sembla raonable per volums.
hotels[which(hotels$agrupacio_categoria=="Habitacio"),"ReCategoria"]<-"Altres"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("oble",hotels$Categoria),"ReCategoria"]<-"Habitacio Doble"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("ndividual",hotels$Categoria),"ReCategoria"]<-"Habitacio Individual"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("uite",hotels$Categoria),"ReCategoria"]<-"Suite"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("riple",hotels$Categoria),"ReCategoria"]<-"Habitacio Triple"
hotels[hotels$agrupacio_categoria=="Habitacio" & grepl("druple",hotels$Categoria),"ReCategoria"]<-"Habitacio quadruple"

hotels.Habitacio<-hotels[hotels$agrupacio_categoria=="Habitacio",]
hotels.Habitacio$ReCategoria<-as.factor(hotels.Habitacio$ReCategoria)

agrupacio_categoria_habitacion<-unique(hotels.Habitacio$ReCategoria)
for (cols in agrupacio_categoria_habitacion) 
{
print(head(hotels.Habitacio[which(hotels.Habitacio$ReCategoria==cols),] %>% group_by(Categoria) %>% summarize(total_cat=n()),10))
}
```

La recategorització sembla raonable respecte els valors observats, per tant ja podem procedir a contruir el dataset de partida per evaluar els objectius descrits

```{r echo=TRUE, warning=FALSE}


#Anem a crear el Dataset de treball

#Creem un identificador de persona
categories_per_persona<-hotels %>% group_by(idPersona) %>% summarize(total_cat=n())

#Creem el dataset de treball
data<-unique(hotels[c("nomHotel","nota.x","data","estrelles","idPersona","nota.y")])
data<-merge(data,categories_per_persona,by.x="idPersona",by.y="idPersona")


#Creem un dataset que ajunti el idcomentari amb l'agrupació de categoria
data.Habitacio<-hotels[hotels$agrupacio_categoria=="Habitacio",]
data.Habitacio<-data.Habitacio[c("idPersona","ReCategoria")]
data.Nits<-hotels[hotels$agrupacio_categoria=="Nits",]
data.Nits<-data.Nits[c("idPersona","ReCategoria")]
data.ProcedenciaComentari<-hotels[hotels$agrupacio_categoria=="ProcedenciaComentari",]
data.ProcedenciaComentari<-data.ProcedenciaComentari[c("idPersona","ReCategoria")]
data.TipusViatge<-hotels[hotels$agrupacio_categoria=="TipusViatge",]
data.TipusViatge<-data.TipusViatge[c("idPersona","ReCategoria")]
data.Acompanyament<-hotels[hotels$agrupacio_categoria=="Acompanyament",]
data.Acompanyament<-data.Acompanyament[c("idPersona","ReCategoria")]
data.ViajaConMascota<-hotels[hotels$agrupacio_categoria=="ViajaConMascota",]
data.ViajaConMascota<-data.ViajaConMascota[c("idPersona","ReCategoria")]

#fem els merges per crear el ddataset de treball
data<-merge(data,data.Habitacio,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.Nits,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.ProcedenciaComentari,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.TipusViatge,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.Acompanyament,by.x="idPersona",by.y="idPersona",all.x = T)
data<-merge(data,data.ViajaConMascota,by.x="idPersona",by.y="idPersona",all.x = T)


colnames(data)<-c("idPersona","nomHotel","notapersona","data","estrelles","notaHotel","num_cat","TipusHabitacio","Nits","ProcedenciaComentari","TipusViatge","Acompanyament","ViajaConMascota")


```

****
#Neteja de dades
****
Mirarem els valors 0 de les notes mitjana d'hotel i les notes de les persons. Recordem que el valor 0 en les estrelles hem entés que significava que era un apartament i per tant no entra en el nostre estudi, ara mirem les notes mitja dels hotels i la nota de les persones

```{r}

#Comencem analitzant des de la perspectiva de l'hotel.
aux.hotels<-unique(data[c("nomHotel","notaHotel","estrelles")])
summary(aux.hotels)

#pel que fa a les estrelles veiem que té una distribució raonable amb valors, etc.. per tant ho donem per bo
#la nota está com a caràcter, anem a posar-la com a númeric
data$notaHotel<-as.numeric(gsub(",",".",data$notaHotel))
aux.hotels$notaHotel<-as.numeric(gsub(",",".",aux.hotels$notaHotel))
summary(aux.hotels)

#Les notes semblen raobales, i no sembla que hi hagi valors extrems ni zeros, ho visualitzem amb el boxplot
boxplot(aux.hotels$notaHotel)


#Analitzem les continues des de la perspectiva del comentari.
summary(data)
#veiem que s'ha de passar les notes a numeric
data$notapersona<-as.numeric(gsub(",",".",data$notapersona))
#hem de posar la data en format data
data$data<-as.Date(data$data)
#Hem arrenjat la nota i la data
summary(data)

#veiem els NA
colSums(is.na(data))


#Anem a pams, pel cas, ViajaConMascota, sabem que si no está informat, es raonable pensar que no viatge ambMascota. Fem una recategorització per transformar-ho en una binaria, els que tenen valors S els que no en tenen N

data[!(is.na(data$ViajaConMascota)),"ViajaConMascota"]<-"S"
data[(is.na(data$ViajaConMascota)),"ViajaConMascota"]<-"N"

#Per tipus de viatge, el volum de NA es un 10% aprox, per tant pensem que té prou instancia per si sol com per afegir un valor més dins la categoria que sigui SENSEINFORMAR per veure impactes en la nota (o altres)

data[(is.na(data$TipusViatge)),"TipusViatge"]<-"SenseInformar"

#Procedencia comentari, només té un valor informat, per tant, entenem que l'altre valor és per web
data[(is.na(data$ProcedenciaComentari)),"ProcedenciaComentari"]<-"EnviadoporWeb"

#A tipusHabitacio I Nits, tenim la sospita que els que estan en NA son els mateixos.
data[(is.na(data$Nits)) |is.na(data$TipusHabitacio),]
#Veiem que si per tant, sembla raonable pensar que és un error i que milor obviar la informació (eliminarla)
data<-data[!(is.na(data$Nits)) & !(is.na(data$TipusHabitacio)),]

summary(data)

#Anem a transformar les variables categóriques as.factor
data$ViajaConMascota<-as.factor(data$ViajaConMascota)
data$Acompanyament<-as.factor(data$Acompanyament)
data$TipusViatge<-as.factor(data$TipusViatge)
data$ProcedenciaComentari<-as.factor(data$ProcedenciaComentari)
data$Nits<-as.factor(data$Nits)
data$TipusHabitacio<-as.factor(data$TipusHabitacio)
data$estrelles<-as.factor(data$estrelles)
data$estrelles<-ordered(data$estrelles,levels=c("1","2","3","4","5"))
data$nomHotel<-as.factor(data$nomHotel)
summary(data)

#Enadonem que acompanyament te un factor que es Familia con niños mayores y Familia con ninos pequeños, i el grup de Familia con ninños mayores es força petit, pel que agrupem els dos nivells a Familiaconniños
levels(data$Acompanyament) <- c("Familiaconniños","Familiaconniños","Grupo","Grupodeamigos","Pareja","Personaqueviajasola")


```
Ens decidim ara a fer les primeres hipotesis, i la primera es que volem saber si les notes que es donen en el primer trimestre de l'any son diferents a les que es donen a l'estiu

PEr això, caldrà, que afegim una variable nova, que determini l'epoca de l'any en funció de la data del comentari (pot haver-hi un decalatge de dies, però assumin que els comentaris es fan aprop de la data en la que s'ha gaudit l'estancia de l'hotel)
```{r}

data$Season<-"PRIMER TRIMESTRE"
data[month(data$data)>=4 & month(data$data)<=6,"Season" ]<-"SEGON TRIMESTRE"
data[month(data$data)>=7 & month(data$data)<=9,"Season" ]<-"TERCER TRIMESTRE"
data[month(data$data)>=10 & month(data$data)<=12,"Season" ]<-"QUART TRIMESTRE"
data$Season<-as.factor(data$Season)
summary(data)

```


```{r}
#Anem a veure si la diferencia en general de les notes de les persones pels hotels difereix entre el primer trimestre i el tercer trimetre. Per això, apliquem un anova.
hotels_1er_3er<-data %>% filter(Season=='PRIMER TRIMESTRE' | Season=='TERCER TRIMESTRE')
aov.hotels_1er_3er=aov(notapersona~Season,hotels_1er_3er)
summary(aov.hotels_1er_3er)
kable(hotels_1er_3er%>% group_by(Season) %>% summarise(n=n(),mean=mean(notapersona),sd=sd(notapersona)))
```

Existeix una fortta evidència de diferencia de les mitjanes de les notes entre el primer trimestre i el tercer. Sembla ser que cap a l'estiu la qualitat es percebuda pitjor que a l'hivern. Això vol dir o que els clients són més exigents o el personal té menys qualitat.

Ara volem veure, d'aquells hotels que tinguin una mostra superior a 30 tant per l'estiu com per l'hivern tenen una nota significativament diferent entre els dos trimestres.


```{r}
#busco els hotels que tinguin com a minim 30 elements tant en el primer trimestre com en el tercer.
hotels_comparables<-data %>% group_by(nomHotel,Season)  %>% filter(Season=='PRIMER TRIMESTRE' | Season=='TERCER TRIMESTRE') %>% summarise(n=n()) %>% filter(n>30) %>% group_by(nomHotel) %>% summarise(n=n()) %>% filter(n==2)
data.hotels_comparables <- data[data$nomHotel %in% hotels_comparables$nomHotel,]
data.hotels_comparables<-data.hotels_comparables %>% filter(Season=='PRIMER TRIMESTRE' | Season=='TERCER TRIMESTRE')

#Anem a fer anova hotel per hotel i creant el resultat en forma de taula
llista_hotels=unique(data.hotels_comparables$nomHotel)
result_aov<-NULL
for (cols in llista_hotels)
{
  hotel_actual<-data.hotels_comparables[data.hotels_comparables$nomHotel==cols,]
  aov.hotel_actual=aov(notapersona~Season,hotel_actual)
  if (is.null(result_aov))
  {
    aux<-hotel_actual %>% group_by(nomHotel,Season) %>% summarise(n=n(),mean=mean(notapersona),sd=sd(notapersona))
    aux.1<-aux[aux$Season=='PRIMER TRIMESTRE',]
    aux.2<-aux[aux$Season=='TERCER TRIMESTRE',]
    aux.merge<-merge(aux.1,aux.2,by.x=c("nomHotel"),by.y=c("nomHotel"))
    result_aov<-cbind(aux.merge,cols,summary(aov.hotel_actual)[[1]][["Pr(>F)"]][1])
  }
  else
  {
    aux<-hotel_actual %>% group_by(nomHotel,Season) %>% summarise(n=n(),mean=mean(notapersona),sd=sd(notapersona))
    aux.1<-aux[aux$Season=='PRIMER TRIMESTRE',]
    aux.2<-aux[aux$Season=='TERCER TRIMESTRE',]
    aux.merge<-merge(aux.1,aux.2,by.x=c("nomHotel"),by.y=c("nomHotel"))
    aux.merge<-cbind(aux.merge,cols,summary(aov.hotel_actual)[[1]][["Pr(>F)"]][1])
    result_aov<-rbind(result_aov,aux.merge)
  }
}

result_aov$diferenciaNota<-FALSE
result_aov[(result_aov$`summary(aov.hotel_actual)[[1]][["Pr(>F)"]][1]`<0.05),"diferenciaNota"]<-TRUE
result_aov$diferencia<-result_aov$mean.x-result_aov$mean.y
kable(result_aov)

```

